# MiniMIDIキーボード ファームウェアガイド

## 1. 概要

このドキュメントは、orpheus pico (Raspberry Pi Pico互換機) を使用した自作MIDIキーボードのファームウェアに関する使い方や仕様を説明するものです。

このファームウェアは以下の機能を持ちます:
- 4オクターブ範囲のMIDIノート出力
- オクターブUP/DOWN機能
- DAWコントロール用のMIDI CCボタン
- 2つのロータリーエンコーダーによるMIDI CC出力
- 操作内容をリアルタイムで表示するLCDディスプレイ機能

## 2. 必要なもの

### ハードウェア
- orpheus pico (またはRaspberry Pi Pico互換機)
- このプロジェクト用に作成されたキーボード基板
- ST7735 LCDディスプレイ
- PCと接続するためのUSBケーブル

### ソフトウェア
- [Visual Studio Code](https://code.visualstudio.com/)
- [PlatformIO IDE 拡張機能](https://platformio.org/platformio-ide)

## 3. インストールとファームウェアの書き込み

1.  **プロジェクトを開く**:
    Visual Studio Codeを起動し、「ファイル」>「フォルダーを開く...」からこのプロジェクトのディレクトリを選択します。

2.  **ライブラリの自動インストール**:
    プロジェクトを初めて開くと、PlatformIOが設定ファイル (`platformio.ini`) を読み込み、必要なライブラリ（USB MIDI、エンコーダー、LCDライブラリなど）を自動的にダウンロード・インストールします。

3.  **ファームウェアの書き込み**:
    - Picoの「BOOTSEL」ボタンを押しながら、PCにUSBケーブルで接続します。
    - VS Codeのターミナル（「ターミナル」>「新しいターミナル」）を開き、以下のコマンドを実行します。

    ```bash
    pio run --target upload
    ```
    - コンパイルと書き込みが自動的に実行されます。書き込みが完了すると、PicoはMIDIキーボードとしてPCに認識されます。

## 4. 機能と使い方

### キーボードとMIDIノート

- **鍵盤レイアウト**:
  - `ROW 0` & `ROW 2`: 黒鍵 (低オクターブ/高オクターブ)
  - `ROW 1` & `ROW 3`: 白鍵 (低オクターブ/高オクターブ)
- **オクターブ変更**:
  - **オクターブUP**: `ROW4, COL5` のキーを押します。 (最大+2)
  - **オクターブDOWN**: `ROW5, COL5` のキーを押します。 (最小-2)
  - 現在のオクターブ設定はLCDの下段に `Oct: ` として表示されます。

### DAWコントロールキー (MIDI CC)

`ROW4`と`ROW5`のキーは、DAWの機能を操作するためのコントロールチェンジ(CC)メッセージを送信します。キーを押している間ON (値:127)、離すとOFF (値:0) となるモーメンタリボタンとして機能します。

| キー (行, 列) | 送信されるCC番号 | 用途の例                               |
| :----------- | :--------------- | :------------------------------------- |
| `ROW4, COL1` | CC 30            | トラック1のミュート/ソロ/録音アーム    |
| `ROW4, COL2` | CC 31            | トラック2のミュート/ソロ/録音アーム    |
| `ROW4, COL3` | CC 32            | トラック3のミュート/ソロ/録音アーム    |
| `ROW4, COL4` | CC 33            | トラック4のミュート/ソロ/録音アーム    |
| `ROW5, COL1` | CC 35            | トランスポート: 再生                   |
| `ROW5, COL2` | CC 36            | トランスポート: 停止                   |
| `ROW5, COL3` | CC 37            | トランスポート: 録音                   |
| `ROW5, COL4` | CC 38            | メトロノーム ON/OFF                    |

### ロータリーエンコーダー

2つのエンコーダーは、回転と押し込みでCCメッセージを送信します。

| 操作                         | 送信されるCC番号 | 値                                 | 用途の例                             |
| :--------------------------- | :--------------- | :--------------------------------- | :----------------------------------- |
| **エンコーダー1 (上) 回転**  | CC 22            | 時計回り: 1, 反時計回り: 127     | 選択トラックのボリューム/パン調整    |
| **エンコーダー1 (上) 押込**  | CC 20            | 押した時: 127, 離した時: 0       | 選択トラックのミュート切り替え       |
| **エンコーダー2 (下) 回転**  | CC 23            | 時計回り: 1, 反時計回り: 127     | マスターボリューム/パン調整          |
| **エンコーダー2 (下) 押込**  | CC 21            | 押した時: 127, 離した時: 0       | マスターミュート/エフェクトON/OFF    |

### LCD情報パネル

LCDには3つのエリアがあり、リアルタイムで情報が更新されます。

- **上段 (Note)**: 最後に押したMIDIノート名と、現在同時に押されているキーの数を表示します。
  - 例: `Note: C#4 (2)`
- **中段 (CC)**: 最後に操作したエンコーダーやボタンのCC情報を表示します。
  - 例: `CC: 22 | Val: 1`
- **下段 (Status)**: 現在のMIDIチャンネルとオクターブ設定を表示します。
  - 例: `Ch:1 Oct:0`

## 5. トラブルシューティング

- **LCDが表示されない、または表示がおかしい**:
  ST7735 LCDにはいくつかの種類があります。`src/main.cpp`の`setup()`関数内にある以下の行を修正してみてください。
  ```cpp
  // この行の...
  tft.initR(INITR_BLACKTAB);
  
  // INITR_BLACKTAB の部分を、お使いのLCDに合わせて以下のように変更
  // tft.initR(INITR_GREENTAB);
  // tft.initR(INITR_REDTAB);
  ```
  また、画面の向きが正しくない場合は、すぐ下にある `tft.setRotation(1);` の数値を `0`, `2`, `3` のいずれかに変更して試してください。

- **キーやエンコーダーの動作がおかしい**:
  以下のコマンドでシリアルモニターを起動すると、PC側で詳細なデバッグログを確認できます。
  ```bash
  pio device monitor
  ```
  これにより、どのキーが認識され、どのようなMIDIメッセージが生成されているかを追跡できます。
